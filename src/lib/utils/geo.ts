const EARTH_RADIUS_MILES = 3958.8;

/**
 * Haversine distance between two lat/lng points in miles.
 */
export function haversineDistance(
  lat1: number,
  lng1: number,
  lat2: number,
  lng2: number
): number {
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return EARTH_RADIUS_MILES * c;
}

function toRad(deg: number): number {
  return (deg * Math.PI) / 180;
}

/**
 * Get a bounding box for SQL pre-filtering.
 * Returns { minLat, maxLat, minLng, maxLng }.
 */
export function getBoundingBox(
  lat: number,
  lng: number,
  radiusMiles: number
): { minLat: number; maxLat: number; minLng: number; maxLng: number } {
  const latDelta = radiusMiles / 69.0;
  const lngDelta = radiusMiles / (69.0 * Math.cos(toRad(lat)));
  return {
    minLat: lat - latDelta,
    maxLat: lat + latDelta,
    minLng: lng - lngDelta,
    maxLng: lng + lngDelta,
  };
}

/**
 * Lookup table for common US zip codes â†’ { lat, lng }.
 * Covers major metros for demo purposes.
 */
const ZIP_COORDS: Record<string, { lat: number; lng: number }> = {
  // Denver metro
  "80202": { lat: 39.7525, lng: -104.9995 },
  "80203": { lat: 39.7312, lng: -104.9826 },
  "80204": { lat: 39.7353, lng: -105.0167 },
  "80205": { lat: 39.7564, lng: -104.9648 },
  "80206": { lat: 39.7340, lng: -104.9557 },
  "80210": { lat: 39.6780, lng: -104.9629 },
  "80220": { lat: 39.7280, lng: -104.9090 },
  "80222": { lat: 39.6650, lng: -104.9270 },
  "80227": { lat: 39.6600, lng: -105.0880 },
  "80229": { lat: 39.8370, lng: -104.9570 },
  "80231": { lat: 39.6680, lng: -104.8880 },
  "80233": { lat: 39.8970, lng: -104.9470 },
  "80234": { lat: 39.9130, lng: -105.0010 },
  "80235": { lat: 39.6430, lng: -105.0750 },
  "80237": { lat: 39.6460, lng: -104.9080 },
  "80239": { lat: 39.7830, lng: -104.8300 },
  "80246": { lat: 39.6880, lng: -104.9280 },
  "80247": { lat: 39.6950, lng: -104.8750 },
  "80249": { lat: 39.7860, lng: -104.7320 },
  "80260": { lat: 39.8670, lng: -105.0070 },
  "80014": { lat: 39.6660, lng: -104.8350 },
  "80015": { lat: 39.6370, lng: -104.7800 },
  "80016": { lat: 39.5870, lng: -104.7370 },
  "80017": { lat: 39.6940, lng: -104.7820 },
  "80112": { lat: 39.5850, lng: -104.8730 },
  "80120": { lat: 39.5960, lng: -104.9540 },
  "80123": { lat: 39.6120, lng: -105.0750 },
  "80127": { lat: 39.5420, lng: -105.1500 },
  "80128": { lat: 39.5770, lng: -105.0780 },
  "80401": { lat: 39.7380, lng: -105.2130 },
  "80403": { lat: 39.7540, lng: -105.2310 },
  // New York City area
  "10001": { lat: 40.7484, lng: -73.9967 },
  "10002": { lat: 40.7157, lng: -73.9863 },
  "10003": { lat: 40.7317, lng: -73.9893 },
  "10010": { lat: 40.7390, lng: -73.9826 },
  "10016": { lat: 40.7459, lng: -73.9781 },
  "10019": { lat: 40.7654, lng: -73.9867 },
  "10022": { lat: 40.7584, lng: -73.9681 },
  "10036": { lat: 40.7590, lng: -73.9897 },
  "11201": { lat: 40.6934, lng: -73.9896 },
  "11211": { lat: 40.7128, lng: -73.9537 },
  // Los Angeles
  "90001": { lat: 33.9425, lng: -118.2551 },
  "90012": { lat: 34.0659, lng: -118.2407 },
  "90024": { lat: 34.0635, lng: -118.4311 },
  "90036": { lat: 34.0693, lng: -118.3477 },
  "90045": { lat: 33.9562, lng: -118.3890 },
  "90210": { lat: 34.0901, lng: -118.4065 },
  // Chicago metro
  "60601": { lat: 41.8862, lng: -87.6186 },
  "60602": { lat: 41.8827, lng: -87.6292 },
  "60603": { lat: 41.8796, lng: -87.6253 },
  "60604": { lat: 41.8780, lng: -87.6298 },
  "60605": { lat: 41.8669, lng: -87.6187 },
  "60606": { lat: 41.8818, lng: -87.6387 },
  "60607": { lat: 41.8729, lng: -87.6548 },
  "60608": { lat: 41.8522, lng: -87.6694 },
  "60609": { lat: 41.8197, lng: -87.6536 },
  "60610": { lat: 41.9063, lng: -87.6363 },
  "60611": { lat: 41.8929, lng: -87.6124 },
  "60612": { lat: 41.8804, lng: -87.6870 },
  "60613": { lat: 41.9543, lng: -87.6557 },
  "60614": { lat: 41.9218, lng: -87.6511 },
  "60615": { lat: 41.8021, lng: -87.5986 },
  "60616": { lat: 41.8417, lng: -87.6299 },
  "60618": { lat: 41.9467, lng: -87.7029 },
  "60622": { lat: 41.8993, lng: -87.6772 },
  "60625": { lat: 41.9700, lng: -87.7067 },
  "60626": { lat: 41.9979, lng: -87.6704 },
  "60629": { lat: 41.7788, lng: -87.7103 },
  "60630": { lat: 41.9692, lng: -87.7594 },
  "60631": { lat: 41.9941, lng: -87.8098 },
  "60632": { lat: 41.8084, lng: -87.7057 },
  "60634": { lat: 41.9454, lng: -87.8075 },
  "60636": { lat: 41.7762, lng: -87.6654 },
  "60637": { lat: 41.7810, lng: -87.6018 },
  "60638": { lat: 41.7817, lng: -87.7762 },
  "60639": { lat: 41.9207, lng: -87.7606 },
  "60640": { lat: 41.9707, lng: -87.6604 },
  "60641": { lat: 41.9467, lng: -87.7497 },
  "60642": { lat: 41.9000, lng: -87.6650 },
  "60643": { lat: 41.6991, lng: -87.6597 },
  "60647": { lat: 41.9209, lng: -87.7023 },
  "60651": { lat: 41.8985, lng: -87.7397 },
  // Houston
  "77002": { lat: 29.7589, lng: -95.3584 },
  "77003": { lat: 29.7476, lng: -95.3402 },
  "77007": { lat: 29.7713, lng: -95.4048 },
  "77030": { lat: 29.7073, lng: -95.3957 },
  "77056": { lat: 29.7455, lng: -95.4625 },
  // Phoenix metro
  "85001": { lat: 33.4487, lng: -112.0770 },
  "85002": { lat: 33.4373, lng: -112.0620 },
  "85003": { lat: 33.4497, lng: -112.0820 },
  "85004": { lat: 33.4543, lng: -112.0660 },
  "85006": { lat: 33.4630, lng: -112.0470 },
  "85007": { lat: 33.4380, lng: -112.1020 },
  "85008": { lat: 33.4680, lng: -111.9950 },
  "85009": { lat: 33.4470, lng: -112.1260 },
  "85012": { lat: 33.5043, lng: -112.0730 },
  "85013": { lat: 33.5130, lng: -112.0810 },
  "85014": { lat: 33.5090, lng: -112.0520 },
  "85015": { lat: 33.5130, lng: -112.1010 },
  "85016": { lat: 33.5091, lng: -112.0153 },
  "85017": { lat: 33.5130, lng: -112.1270 },
  "85018": { lat: 33.5090, lng: -111.9830 },
  "85019": { lat: 33.5120, lng: -112.1460 },
  "85020": { lat: 33.5630, lng: -112.0530 },
  "85021": { lat: 33.5580, lng: -112.0960 },
  "85022": { lat: 33.6340, lng: -112.0490 },
  "85023": { lat: 33.6340, lng: -112.0960 },
  "85024": { lat: 33.6780, lng: -112.0480 },
  "85028": { lat: 33.5810, lng: -112.0480 },
  "85029": { lat: 33.5990, lng: -112.1130 },
  "85032": { lat: 33.6200, lng: -111.9860 },
  "85033": { lat: 33.4960, lng: -112.1760 },
  "85034": { lat: 33.4291, lng: -112.0250 },
  "85035": { lat: 33.4500, lng: -111.9590 },
  "85040": { lat: 33.3940, lng: -112.0160 },
  "85041": { lat: 33.3850, lng: -112.0810 },
  "85042": { lat: 33.3780, lng: -112.0230 },
  "85043": { lat: 33.4360, lng: -112.1980 },
  "85044": { lat: 33.3400, lng: -111.9810 },
  "85048": { lat: 33.3080, lng: -111.9810 },
  "85050": { lat: 33.6810, lng: -111.9860 },
  "85051": { lat: 33.5600, lng: -112.1310 },
  // Portland
  "97201": { lat: 45.5072, lng: -122.6900 },
  "97202": { lat: 45.4766, lng: -122.6378 },
  "97209": { lat: 45.5306, lng: -122.6851 },
  "97214": { lat: 45.5128, lng: -122.6414 },
  "97232": { lat: 45.5305, lng: -122.6443 },
  // Seattle
  "98101": { lat: 47.6114, lng: -122.3376 },
  "98103": { lat: 47.6726, lng: -122.3420 },
  "98105": { lat: 47.6614, lng: -122.2898 },
  "98115": { lat: 47.6857, lng: -122.2872 },
  "98122": { lat: 47.6133, lng: -122.3092 },
  // Atlanta
  "30301": { lat: 33.7618, lng: -84.3880 },
  "30305": { lat: 33.8351, lng: -84.3888 },
  "30308": { lat: 33.7726, lng: -84.3746 },
  "30309": { lat: 33.7952, lng: -84.3857 },
  "30318": { lat: 33.7971, lng: -84.4360 },
  // Dallas
  "75201": { lat: 32.7874, lng: -96.7988 },
  "75204": { lat: 32.8021, lng: -96.7855 },
  "75205": { lat: 32.8349, lng: -96.7934 },
  "75206": { lat: 32.8200, lng: -96.7709 },
  "75219": { lat: 32.8107, lng: -96.8080 },
  // Miami
  "33101": { lat: 25.7748, lng: -80.1936 },
  "33125": { lat: 25.7730, lng: -80.2340 },
  "33130": { lat: 25.7628, lng: -80.2031 },
  "33132": { lat: 25.7758, lng: -80.1861 },
  "33139": { lat: 25.7834, lng: -80.1342 },
};

/**
 * Look up coordinates for a zip code.
 * Returns null if the zip is not in the lookup table.
 */
export function zipToCoords(zip: string): { lat: number; lng: number } | null {
  return ZIP_COORDS[zip] ?? null;
}

/**
 * Default coordinates (Denver, CO) used when no zip is provided.
 */
export const DEFAULT_COORDS = { lat: 39.7392, lng: -104.9903 };
